export const config = { api: { bodyParser: { sizeLimit: '5mb' } } };

async function getCurrentFile(owner, repo, path, branch, token) {
  const r = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`,
    { headers: { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` } }
  );
  if (r.status === 404) return null;
  if (!r.ok) throw new Error(await r.text());
  return await r.json(); // { sha, content, ... }
}

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Use POST' });

  try {
    const token  = process.env.JKWE_GH_TOKEN;
    const owner  = process.env.JKWE_GH_OWNER;
    const repo   = process.env.JKWE_GH_REPO;
    const branch = process.env.JKWE_GH_BRANCH || 'main';
    const path   = process.env.JKWE_GH_PATH || 'data/movies.json';
    const name   = process.env.JKWE_GH_COMMITTER_NAME || 'JKWE Bot';
    const email  = process.env.JKWE_GH_COMMITTER_EMAIL || 'bot@jkwe.local';

    if (!token) return res.status(500).json({ error: 'Missing JKWE_GH_TOKEN' });

    // Validate payload
    const body = req.body;
    const movies = Array.isArray(body) ? body : (body && body.movies);
    if (!Array.isArray(movies)) return res.status(400).json({ error: 'Expected array or {movies:[]}' });

    const payload = JSON.stringify({ movies }, null, 2);
    const b64 = Buffer.from(payload, 'utf8').toString('base64');

    const current = await getCurrentFile(owner, repo, path, branch, token);
    const sha = current?.sha;

    const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
      method: 'PUT',
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Update movies.json (${new Date().toISOString()})`,
        content: b64,
        branch,
        sha,
        committer: { name, email }
      })
    });

    if (!r.ok) return res.status(r.status).json({ error: await r.text() });
    const out = await r.json();
    return res.status(200).json({ ok: true, sha: out.content?.sha });
  } catch (e) {
    return res.status(500).json({ error: String(e) });
  }
}
