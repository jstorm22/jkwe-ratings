<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JKWE Â· Jonathan & Karl Watch Everything</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tabular-nums{font-variant-numeric:tabular-nums}
    .line-clamp-4{display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
    .shadow-card{box-shadow:0 6px 24px rgba(0,0,0,.07),0 2px 8px rgba(0,0,0,.06)}
    .grid-autofill{grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:640px){.grid-autofill{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (min-width:1024px){.grid-autofill{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (min-width:1280px){.grid-autofill{grid-template-columns:repeat(4,minmax(0,1fr))}}
  </style>
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div id="app"></div>

  <!-- Card template -->
  <template id="card-tpl">
    <div class="group relative overflow-hidden rounded-2xl border bg-white shadow-card hover:shadow-lg transition">
      <!-- Rank badges -->
      <div class="absolute top-2 left-2 z-10">
        <span class="text-[10px] px-2 py-1 rounded-full bg-black/80 text-white">J#â€”</span>
      </div>
      <div class="absolute top-2 right-2 z-10">
        <span class="text-[10px] px-2 py-1 rounded-full bg-black/80 text-white">K#â€”</span>
      </div>

      <!-- Poster -->
      <div class="aspect-[2/3] overflow-hidden bg-gray-100">
        <img class="w-full h-full object-cover group-hover:scale-[1.02] transition poster" alt="">
      </div>

      <!-- Body -->
      <div class="p-4 space-y-2">
        <div class="title text-lg font-semibold leading-tight"></div>
        <p class="synopsis text-sm text-gray-700 line-clamp-4"></p>
        <div class="hovermeta text-xs text-gray-600 opacity-0 group-hover:opacity-100 transition"></div>
      </div>
    </div>
  </template>

  <!-- Ranked row template (two-column compare is rendered with <ol>) -->
  <template id="rank-li-tpl">
    <li class="py-1"></li>
  </template>

  <!-- Unlock overlay -->
  <div id="unlock" class="hidden fixed inset-0 z-50 bg-black/40 items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 space-y-4">
      <div class="text-lg font-semibold">Unlock Editor</div>
      <p class="text-sm text-gray-600">Enter the editor password to access Editors.</p>
      <input id="pw-input" type="password" placeholder="Enter password" class="w-full px-3 py-2 rounded-xl border focus:outline-none focus:ring"/>
      <div id="pw-err" class="text-sm text-red-600 hidden">Incorrect password. Try again.</div>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button id="pw-cancel" class="px-3 py-2 rounded-xl border">Cancel</button>
        <button id="pw-apply" class="px-3 py-2 rounded-xl border bg-black text-white">Unlock</button>
      </div>
    </div>
  </div>

  <script>
  // ========= Cloud endpoints (created earlier on Vercel) =========
  const EP = {
    settings: '/api/settings',   // GET/PUT JSON {siteTitle, tagline, editPassword, podcastEmbed}
    movies:   '/api/movies',     // GET/PUT JSON [ ...movies ]
    omdb:     '/api/omdb'        // GET ?i=tt1234567  (server proxies OMDb with OMDB_KEY)
  };

  // ========= State =========
  let settings = {
    siteTitle: "Jonathan & Karl Watch Everything: Movies and Television",
    tagline: "watch along with us â€¦",
    editPassword: "jkwejg25",
    podcastEmbed: ""
  };
  let movies = []; // [{id,title,year,poster,synopsis,genres,runtimeMin,director,cast[],imdbUrl,ranks:{jonathan,karl},isSeries?}]
  let unlocked = false;
  let tab = 'movies'; // movies | ranked | podcast | editor
  let q = '';

  // ========= Utils =========
  const qs = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const esc = (v) => String(v ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
  const ensureId = (title, year) => (title+'-'+(year||'')).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  const topNbold = (el, n=10) => { qsa('li', el).forEach((li,i)=>{ if(i<n) li.classList.add('font-semibold'); }); };
  const scrollTop = () => window.scrollTo({top:0, behavior:'instant'});

  function rankMap(list, who){
    // Dense ranks by each person based on ranks.{who}
    const m = new Map();
    list.forEach(x => {
      const r = x?.ranks?.[who];
      if (typeof r === 'number') m.set(x.id || ensureId(x.title, x.year), r);
    });
    return m;
  }

  // ========= Data IO =========
  async function loadAll(){
    const [sRes, mRes] = await Promise.all([fetch(EP.settings), fetch(EP.movies)]);
    if (sRes.ok) settings = await sRes.json();
    if (mRes.ok) movies   = await mRes.json();
    // Normalize ids
    movies = movies.map(m => ({ id: m.id || ensureId(m.title, m.year), ...m }));
  }

  async function saveSettings(next){
    const res = await fetch(EP.settings, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(next) });
    if (!res.ok) throw new Error('Failed to save settings');
    settings = await res.json();
  }
  async function saveMovies(next){
    const res = await fetch(EP.movies, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(next) });
    if (!res.ok) throw new Error('Failed to save movies');
    movies = await res.json();
  }

  async function fetchOMDbByUrl(imdbUrl){
    // Accept full IMDb URL; extract tt id
    const m = String(imdbUrl||'').match(/tt\d+/);
    if (!m) throw new Error('IMDb ID not found in URL');
    const id = m[0];
    const res = await fetch(`${EP.omdb}?i=${id}`);
    if (!res.ok) throw new Error('OMDb fetch failed');
    const o = await res.json();
    return {
      year: Number(o.Year) || null,
      poster: (o.Poster && o.Poster !== 'N/A') ? o.Poster : '',
      synopsis: o.Plot && o.Plot !== 'N/A' ? o.Plot : '',
      runtimeMin: (o.Runtime && /\d+/.test(o.Runtime)) ? Number(o.Runtime.match(/\d+/)[0]) : null,
      director: o.Director && o.Director !== 'N/A' ? o.Director : '',
      genres: o.Genre ? o.Genre.split(',').map(s=>s.trim()).filter(Boolean) : [],
      cast: o.Actors ? o.Actors.split(',').map(s=>s.trim()).slice(0,8) : [] // store up to 8; show 4 on hover
    };
  }

  // ========= Render =========
  const app = qs('#app');

  function render(){
    app.innerHTML = '';

    // Header
    const head = document.createElement('header');
    head.className = 'sticky top-0 z-40 backdrop-blur bg-white/80 border-b';
    head.innerHTML = `
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-lg bg-black text-white flex items-center justify-center font-bold">JK</div>
          <div>
            <div class="text-xl font-semibold tracking-tight">${esc(settings.siteTitle)}</div>
            <div class="text-xs text-gray-600">${esc(settings.tagline)}</div>
          </div>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <input id="search" placeholder="Search title, year, genre, castâ€¦" value="${esc(q)}" class="px-3 py-2 rounded-xl border w-64 focus:outline-none focus:ring hidden sm:block"/>
          ${!unlocked
            ? '<button id="btn-unlock" class="px-3 py-2 rounded-xl border hover:shadow" title="Unlock editor">ðŸ”’ Unlock</button>'
            : '<button id="btn-lock" class="px-3 py-2 rounded-xl border hover:shadow" title="Lock editor">ðŸ”“ Lock</button>'}
        </div>
      </div>
      <div class="max-w-6xl mx-auto px-4 pb-3 flex items-center gap-2">
        ${tabBtn('movies','Movies')}
        ${tabBtn('ranked','Ranked List')}
        ${tabBtn('podcast','Podcast')}
        ${unlocked ? tabBtn('editor','Editors') : ''}
      </div>
    `;
    app.appendChild(head);

    const main = document.createElement('main');
    main.className = 'max-w-6xl mx-auto px-4 py-6 space-y-6';

    const filtered = filterMovies(movies, q);
    const jr = rankMap(movies, 'jonathan'); // use full list for consistent J#/K#
    const kr = rankMap(movies, 'karl');

    if (tab === 'movies') main.appendChild(renderMoviesGrid(filtered, jr, kr));
    if (tab === 'ranked') main.appendChild(renderRankedTwoCol(movies));
    if (tab === 'podcast') main.appendChild(renderPodcast());
    if (tab === 'editor' && unlocked) main.appendChild(renderEditor());

    app.appendChild(main);

    // Wire
    const s = qs('#search'); if (s) s.addEventListener('input', e => { q = e.target.value; render(); });
    const u = qs('#btn-unlock'); if (u) u.addEventListener('click', openUnlock);
    const l = qs('#btn-lock'); if (l) l.addEventListener('click', () => { unlocked=false; tab='movies'; render(); });
    qsa('[data-tab]').forEach(b => b.addEventListener('click', () => { tab = b.dataset.tab; scrollTop(); render(); }));
  }

  function tabBtn(key, label){
    const active = tab===key ? 'bg-black text-white' : '';
    return `<button data-tab="${key}" class="px-3 py-2 rounded-xl border ${active}">${label}</button>`;
  }

  function filterMovies(list, term){
    const s = String(term||'').trim().toLowerCase();
    if (!s) return list;
    return list.filter(m => [
      m.title, String(m.year||''), m.director||'', ...(m.genres||[]), ...(m.cast||[])
    ].filter(Boolean).some(t => String(t).toLowerCase().includes(s)));
  }

  function renderMoviesGrid(list, jr, kr){
    const wrap = document.createElement('div');
    wrap.className = 'grid gap-6 grid-autofill';
    const tpl = qs('#card-tpl');

    list.forEach(m => {
      const node = tpl.content.firstElementChild.cloneNode(true);
      const id = m.id || ensureId(m.title, m.year);

      // Ranks
      node.querySelector('.absolute.top-2.left-2 span').textContent = `J#${jr.get(id) ?? 'â€”'}`;
      node.querySelector('.absolute.top-2.right-2 span').textContent = `K#${kr.get(id) ?? 'â€”'}`;

      // Poster
      const img = node.querySelector('.poster');
      if (m.poster) {
        img.src = m.poster; img.alt = `${m.title} poster`;
        img.onerror = () => { img.src=''; img.parentElement.classList.add('bg-gray-200'); };
      } else {
        img.remove();
      }

      // Click â†’ IMDb (if present)
      if (m.imdbUrl) {
        node.style.cursor = 'pointer';
        node.addEventListener('click', (e) => {
          // Avoid hijacking selection/copy
          if (e.target.closest('a,button,input,textarea')) return;
          window.open(m.imdbUrl, '_blank');
        });
      }

      // Title + synopsis
      node.querySelector('.title').innerHTML = `${esc(m.title)} ${m.year?`<span class="text-gray-500 font-normal">(${m.year})</span>`:''}`;
      const syn = node.querySelector('.synopsis');
      if (m.synopsis) syn.textContent = m.synopsis; else syn.remove();

      // Hover meta (Director â†’ Cast(4) â†’ Runtime)
      const bits = [];
      if (m.director) bits.push(`<b>Director:</b> ${esc(m.director)}`);
      if (m.cast && m.cast.length) bits.push(`<b>Cast:</b> ${m.cast.slice(0,4).map(esc).join(', ')}`);
      if (m.runtimeMin) bits.push(`<b>Runtime:</b> ${m.runtimeMin} min`);
      node.querySelector('.hovermeta').innerHTML = bits.join('<br/>');

      wrap.appendChild(node);
    });

    return wrap;
  }

  function renderRankedTwoCol(list){
    // Build maps from declared ranks
    const byJ = [...list].filter(x => typeof x?.ranks?.jonathan === 'number')
      .sort((a,b)=>a.ranks.jonathan - b.ranks.jonathan);
    const byK = [...list].filter(x => typeof x?.ranks?.karl === 'number')
      .sort((a,b)=>a.ranks.karl - b.ranks.karl);

    const wrap = document.createElement('div');
    wrap.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';

    const tpl = qs('#rank-li-tpl');

    function col(title, arr, who){
      const card = document.createElement('div');
      card.className = 'rounded-2xl border bg-white shadow-card';
      card.innerHTML = `<div class="px-4 py-3 border-b font-semibold">${title}</div><div class="p-4"><ol class="list-decimal pl-5 space-y-1"></ol></div>`;
      const ol = card.querySelector('ol');
      arr.forEach((m,i) => {
        const li = tpl.content.firstElementChild.cloneNode(true);
        li.textContent = m.title;
        if (i < 10) li.classList.add('font-semibold'); // Top 10 bold
        ol.appendChild(li);
      });
      return card;
    }

    wrap.appendChild(col("Jonathanâ€™s Ranked List", byJ, 'jonathan'));
    wrap.appendChild(col("Karlâ€™s Ranked List", byK, 'karl'));
    return wrap;
  }

  function renderPodcast(){
    const box = document.createElement('div');
    const src = settings.podcastEmbed || '';
    // Accept full iframe embed (extract src=) or direct embed URL
    let embedSrc = src;
    const m = src.match(/src="([^"]+)"/i);
    if (m) embedSrc = m[1];

    box.innerHTML = `
      <div class="rounded-2xl border bg-white shadow-card overflow-hidden">
        <div class="px-4 py-3 border-b font-semibold">Listen to our podcast</div>
        <div class="p-4">
          ${embedSrc ? `
            <iframe height="450" width="100%" title="Media player"
              src="${esc(embedSrc)}" id="embedPlayer"
              sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation"
              allow="autoplay *; encrypted-media; clipboard-write"
              style="border:0;border-radius:12px;width:100%;height:450px;max-width:100%;">
            </iframe>
          ` : `
            <div class="text-sm text-gray-600">No podcast embed set yet. Add it in Editors â†’ Settings.</div>
          `}
        </div>
      </div>
    `;
    return box;
  }

  function renderEditor(){
    const wrap = document.createElement('div');
    wrap.className = 'space-y-6';

    // Settings card
    const s = document.createElement('div');
    s.className = 'rounded-2xl border bg-white shadow-card';
    s.innerHTML = `
      <div class="px-4 py-3 border-b font-semibold">Settings</div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block"><span class="text-sm">Site title</span><input id="st-title" class="mt-1 w-full px-3 py-2 rounded-xl border" value="${esc(settings.siteTitle)}"/></label>
        <label class="block"><span class="text-sm">Tagline</span><input id="st-tag" class="mt-1 w-full px-3 py-2 rounded-xl border" value="${esc(settings.tagline)}"/></label>
        <label class="block md:col-span-2"><span class="text-sm">Podcast embed (Apple iframe OR URL)</span><input id="st-pod" class="mt-1 w-full px-3 py-2 rounded-xl border" value="${esc(settings.podcastEmbed)}"/></label>
        <label class="block md:col-span-2"><span class="text-sm">Editor password</span><input id="st-pass" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border" value="${esc(settings.editPassword)}"/></label>
        <div class="md:col-span-2"><button id="st-save" class="px-3 py-2 rounded-xl border bg-black text-white">Save Settings</button></div>
      </div>
    `;
    wrap.appendChild(s);

    // Movies card
    const m = document.createElement('div');
    m.className = 'rounded-2xl border bg-white shadow-card';
    m.innerHTML = `
      <div class="px-4 py-3 border-b font-semibold">Movies (Edit / Add)</div>
      <div class="p-4 space-y-4">
        <div class="rounded-xl border">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="text-left px-2 py-2">Title</th>
                <th class="text-left px-2 py-2">Year</th>
                <th class="text-left px-2 py-2">IMDb</th>
                <th class="text-left px-2 py-2">Director</th>
                <th class="text-left px-2 py-2">Cast (comma-sep)</th>
                <th class="text-left px-2 py-2">J</th>
                <th class="text-left px-2 py-2">K</th>
                <th class="text-left px-2 py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="mv-tbody"></tbody>
          </table>
        </div>
        <button id="mv-add" class="px-3 py-2 rounded-xl border">Add Movie</button>
        <button id="mv-saveall" class="px-3 py-2 rounded-xl border bg-black text-white">Save All</button>
      </div>
    `;
    wrap.appendChild(m);

    // Wire settings
    setTimeout(()=>{
      qs('#st-save').addEventListener('click', async ()=>{
        const next = {
          siteTitle: qs('#st-title').value.trim(),
          tagline: qs('#st-tag').value.trim(),
          podcastEmbed: qs('#st-pod').value.trim(),
          editPassword: qs('#st-pass').value
        };
        await saveSettings(next);
        alert('Settings saved'); render();
      });
    });

    // Render movies table
    const tbody = m.querySelector('#mv-tbody');
    function rowFor(item){
      const tr = document.createElement('tr');
      tr.className = 'border-b last:border-none align-top';
      tr.innerHTML = `
        <td class="px-2 py-2"><input class="w-56 px-2 py-1 rounded border mv-title" value="${esc(item.title||'')}"/></td>
        <td class="px-2 py-2"><input class="w-16 px-2 py-1 rounded border mv-year" value="${esc(item.year||'')}"/></td>
        <td class="px-2 py-2"><input class="w-60 px-2 py-1 rounded border mv-imdb" value="${esc(item.imdbUrl||'')}"/></td>
        <td class="px-2 py-2"><input class="w-44 px-2 py-1 rounded border mv-dir" value="${esc(item.director||'')}"/></td>
        <td class="px-2 py-2"><input class="w-72 px-2 py-1 rounded border mv-cast" value="${esc((item.cast||[]).join(', '))}"/></td>
        <td class="px-2 py-2"><input class="w-12 px-2 py-1 rounded border mv-j" value="${esc(item?.ranks?.jonathan||'')}"/></td>
        <td class="px-2 py-2"><input class="w-12 px-2 py-1 rounded border mv-k" value="${esc(item?.ranks?.karl||'')}"/></td>
        <td class="px-2 py-2 space-x-2">
          <button class="px-2 py-1 rounded border btn-fetch">Fetch</button>
          <button class="px-2 py-1 rounded border btn-del">Delete</button>
        </td>
      `;
      // Actions
      tr.querySelector('.btn-fetch').addEventListener('click', async ()=>{
        try{
          const url = tr.querySelector('.mv-imdb').value.trim();
          const patch = await fetchOMDbByUrl(url);
          tr.querySelector('.mv-year').value = patch.year || '';
          tr.querySelector('.mv-dir').value  = patch.director || '';
          tr.querySelector('.mv-cast').value = (patch.cast||[]).join(', ');
          // Stash poster & synopsis on the element for saveAll
          tr.dataset.poster = patch.poster || '';
          tr.dataset.synopsis = patch.synopsis || '';
          tr.dataset.runtimeMin = patch.runtimeMin || '';
          alert('Fetched from OMDb');
        }catch(err){ alert(err.message); }
      });
      tr.querySelector('.btn-del').addEventListener('click', ()=>{
        tr.remove();
      });
      return tr;
    }

    movies.forEach(mv => tbody.appendChild(rowFor(mv)));
    qs('#mv-add').addEventListener('click', ()=> tbody.appendChild(rowFor({
      title:'', year:'', imdbUrl:'', director:'', cast:[], ranks:{jonathan:null,karl:null}
    })));

    qs('#mv-saveall').addEventListener('click', async ()=>{
      const rows = qsa('tr', tbody);
      const next = rows.map(tr => {
        const title = tr.querySelector('.mv-title').value.trim();
        const year  = Number(tr.querySelector('.mv-year').value)||null;
        const imdb  = tr.querySelector('.mv-imdb').value.trim();
        const dir   = tr.querySelector('.mv-dir').value.trim();
        const cast  = tr.querySelector('.mv-cast').value.split(',').map(s=>s.trim()).filter(Boolean);
        const jr    = Number(tr.querySelector('.mv-j').value)||null;
        const kr    = Number(tr.querySelector('.mv-k').value)||null;
        const poster = tr.dataset.poster || '';
        const synopsis = tr.dataset.synopsis || '';
        const runtimeMin = tr.dataset.runtimeMin ? Number(tr.dataset.runtimeMin) : null;

        return {
          id: ensureId(title, year),
          title, year, imdbUrl: imdb, director: dir, cast,
          poster: poster || (movies.find(x=>x.title===title && x.year===year)?.poster || ''),
          synopsis: synopsis || (movies.find(x=>x.title===title && x.year===year)?.synopsis || ''),
          runtimeMin: runtimeMin || (movies.find(x=>x.title===title && x.year===year)?.runtimeMin || null),
          genres: movies.find(x=>x.title===title && x.year===year)?.genres || [],
          ranks: { jonathan: jr, karl: kr }
        };
      });
      await saveMovies(next);
      alert('Movies saved'); render();
    });

    return wrap;
  }

  // ========= Unlock modal =========
  function openUnlock(){
    const el = qs('#unlock'); el.classList.remove('hidden'); el.classList.add('flex');
    const input = qs('#pw-input'); const err = qs('#pw-err');
    const onApply = () => {
      if (input.value === settings.editPassword){ unlocked = true; tab='editor'; close(); render(); }
      else err.classList.remove('hidden');
    };
    const close = () => {
      el.classList.add('hidden'); el.classList.remove('flex');
      qs('#pw-apply').removeEventListener('click', onApply);
      qs('#pw-cancel').removeEventListener('click', close);
      input.removeEventListener('keydown', onKey);
    };
    const onKey = (e)=>{ if(e.key==='Enter') onApply(); if(e.key==='Escape') close(); };
    qs('#pw-apply').addEventListener('click', onApply);
    qs('#pw-cancel').addEventListener('click', close);
    input.addEventListener('keydown', onKey);
    input.value=''; err.classList.add('hidden'); input.focus();
  }

  // ========= Boot =========
  (async function(){
    try{ await loadAll(); }catch(e){ console.warn('Cloud load failed, using defaults', e); }
    // Tab from ?tab=
    const p = new URLSearchParams(location.search);
    tab = ['movies','ranked','podcast','editor'].includes(p.get('tab')) ? p.get('tab') : 'movies';
    render();
  })();
  </script>
</body>
</html>
