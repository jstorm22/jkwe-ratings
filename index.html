<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jonathan & Karl Watch Everything Â· JKWE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tabular-nums { font-variant-numeric: tabular-nums; }
    .line-clamp-8 { display: -webkit-box; -webkit-line-clamp: 8; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div id="app"></div>
  <input id="file-input" type="file" accept="application/json" class="hidden" />

  <!-- Movie card template -->
  <template id="card-template">
    <div class="group rounded-xl border overflow-hidden shadow-sm hover:shadow-md transition relative bg-white">
      <!-- rank badges -->
      <span class="jbadge absolute top-2 left-2 z-10 text-[10px] px-2 py-1 rounded-full bg-black/80 text-white"></span>
      <span class="kbadge absolute top-2 right-2 z-10 text-[10px] px-2 py-1 rounded-full bg-black/60 text-white"></span>

      <div class="posterWrap aspect-[2/3] overflow-hidden bg-gray-100">
        <img class="poster w-full h-full object-cover" alt="poster" onerror="this.style.display='none'" />
      </div>

      <div class="p-3 space-y-2 relative">
        <div class="title text-base font-semibold leading-tight"></div>
        <p class="synopsis text-sm text-gray-700 line-clamp-8"></p>

        <!-- hover meta overlay -->
        <div class="absolute inset-0 bg-black/70 text-white text-xs p-3 flex flex-col gap-1 pointer-events-none opacity-0 group-hover:opacity-100 transition">
          <div class="mt-auto space-y-1">
            <div class="meta-dir"></div>
            <div class="meta-prod"></div>
            <div class="meta-run"></div>
            <div class="meta-bud"></div>
            <div class="meta-dist"></div>
            <div class="text-[10px] opacity-80">Hover for details Â· Click opens IMDb</div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    /* =========================
       Password / Settings (local)
       ========================= */
    function getPassword(){ return localStorage.getItem('jkwe_pw') || 'sage42'; }
    function setPassword(p){ localStorage.setItem('jkwe_pw', p); }
    let EDIT_PASSWORD = getPassword();

    function getOmdbKey(){ return localStorage.getItem('jkwe_omdb_key') || ''; }
    function setOmdbKey(k){ localStorage.setItem('jkwe_omdb_key', k); }

    function getPodcastEmbed(){ return localStorage.getItem('jkwe_podcast_embed') || ''; }
    function setPodcastEmbed(v){ localStorage.setItem('jkwe_podcast_embed', v); }

    /* =========================
       Canonical ranking order (from your master list)
       ========================= */
    const J_LIST = [
      'Jurassic Park','Mandalorian â€“ Season One','Superman (2025)','Fantastic Four: First Steps','The Northman','Sinners',
      'Psycho','Top Gun: Maverick','Amsterdam','Kiss Of The Spider-Woman','Dahmer â€“ Monster: The Jeffrey Dahmer Story',
      'Psycho Beach Party','Under The Skin','Gone With The Wind','Carry-On','A Streetcar Named Desire',
      'The Lost World: Jurassic Park','Jurassic World: Rebirth','Jurassic World: Dominion','King Kong (1933)','The Happytime Murders',
      'Dunkirk','Jurassic Park III','Jurassic World: Fallen Kingdom','The Graduate','Some Like It Hot','Jurassic World',
      'Rebel Moon Part Two','Gran Turismo','RuPaulâ€™s Drag Race â€“ Season Nine','Safe House','RuPaulâ€™s Drag Race â€“ Season Five',
      'Rebel Moon Part One','Top Gun','Space Jam','Paul','Avatar 2: The Way Of Water','Avatar','Space Jam: A New Legacy'
    ];

    const K_LIST = [
      'Jurassic Park','Sinners','Superman (2025)','Fantastic Four: First Steps','The Northman','Amsterdam','Dunkirk','Psycho',
      'Under The Skin','Space Jam','King Kong (1933)','Kiss Of The Spider-Woman','Mandalorian â€“ Season One','Safe House',
      'Carry-On','The Lost World: Jurassic Park','Jurassic World: Rebirth','Psycho Beach Party','Some Like It Hot','Gran Turismo',
      'RuPaulâ€™s Drag Race â€“ Season Nine','Jurassic Park III','A Streetcar Named Desire','The Happytime Murders',
      'Jurassic World: Dominion','Jurassic World: Fallen Kingdom','Dahmer â€“ Monster: The Jeffrey Dahmer Story','The Graduate',
      'Paul','Jurassic World','Rebel Moon: Part Two','Top Gun: Maverick','Space Jam: A New Legacy','RuPaulâ€™s Drag Race â€“ Season Five',
      'Avatar 2: The Way Of Water','Rebel Moon: Part One','Avatar','Gone With The Wind','Top Gun'
    ];

    // Optional IMDb hints to speed up linking
    const IMDB_HINTS = new Map([
      ['Kiss Of The Spider-Woman', 'https://www.imdb.com/title/tt0089424/'],
      ['A Streetcar Named Desire', 'https://www.imdb.com/title/tt0044081/'],
      ['Some Like It Hot', 'https://www.imdb.com/title/tt0053291/'],
      ['Psycho Beach Party', 'https://www.imdb.com/title/tt0120051/'],
      ['The Happytime Murders', 'https://www.imdb.com/title/tt1308728/'],
      ['Carry-On', 'https://www.imdb.com/title/tt21382296/']
    ]);

    /* =========================
       Build initial dataset from lists
       ========================= */
    const TITLES = Array.from(new Set([...J_LIST, ...K_LIST]));
    const moviesBase = TITLES.map(title => ({
      id: slugify(title),
      title,
      year: (title.match(/\((\d{4})\)/) ? parseInt(title.match(/\((\d{4})\)/)[1],10) : undefined),
      poster: undefined,
      synopsis: undefined,
      director: undefined,
      producers: undefined,
      runtimeMin: undefined,
      budget: undefined,
      distributor: undefined,
      imdbUrl: IMDB_HINTS.get(title),
      ratings: {
        jonathan: J_LIST.indexOf(title) >= 0 ? (J_LIST.indexOf(title)+1) : undefined,
        karl:      K_LIST.indexOf(title) >= 0 ? (K_LIST.indexOf(title)+1) : undefined
      }
    }));

    /* =========================
       App state
       ========================= */
    let unlocked = sessionStorage.getItem('jkwe_unlocked') === '1';
    let activeTab = 'movies';   // movies | ranked | podcast | editor
    let query = '';
    let movies = moviesBase;

    /* =========================
       Utilities
       ========================= */
    function qs(s, r=document){ return r.querySelector(s); }
    function escapeAttr(v){ return String(v).replace(/"/g,'&quot;'); }
    function escapeHtml(s){
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'};
      return String(s).replace(/[&<>"']/g, ch => map[ch]);
    }
    function slugify(s){ return String(s).normalize('NFKD').replace(/[^\w\s-]/g,'').trim().replace(/[\s_]+/g,'-').replace(/-+/g,'-').toLowerCase(); }

    /* =========================
       IMDb / OMDb Auto-Fetch
       ========================= */
    async function fetchIMDbData(imdbUrl, row) {
      try {
        const match = imdbUrl && imdbUrl.match(/tt\d+/);
        if (!match) { alert("Invalid IMDb link. It must contain an id like tt0044081."); return; }
        const imdbID = match[0];
        const apiKey = getOmdbKey();
        if (!apiKey) { alert("OMDb API key is not set. In Editors â†’ OMDb Settings, save your key first."); return; }

        const res = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${apiKey}`);
        const data = await res.json();
        if (data.Response === "False") { alert("OMDb error: " + data.Error); return; }

        const q = sel => row.querySelector(sel);
        const cleanMin = v => (typeof v === 'string' && v.endsWith(' min')) ? v.replace(' min','') : v;

        q('.e-title')  && (q('.e-title').value  = data.Title || '');
        q('.e-year')   && (q('.e-year').value   = data.Year || '');
        q('.e-dir')    && (q('.e-dir').value    = data.Director || '');
        q('.e-run')    && (q('.e-run').value    = cleanMin(data.Runtime || ''));
        q('.e-prod')   && (q('.e-prod').value   = data.Production || '');
        q('.e-dist')   && (q('.e-dist').value   = data.Distributor || '');
        q('.e-poster') && (q('.e-poster').value = data.Poster || '');
        q('.e-syn')    && (q('.e-syn').value    = data.Plot || '');

        alert(`Fetched data for: ${data.Title}`);
      } catch (err) {
        console.error(err);
        alert("Error fetching from OMDb.");
      }
    }

    /* =========================
       Root render
       ========================= */
    function render(){
      const app = qs('#app');
      app.innerHTML = `
        <div class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b">
          <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
            <!-- Logo -->
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded bg-orange-500 grid grid-cols-2 grid-rows-2 text-white font-black place-items-center text-sm leading-none select-none">
                <span>J</span><span>K</span><span>W</span><span>E</span>
              </div>
              <div>
                <div class="text-lg sm:text-xl font-semibold tracking-tight">Jonathan & Karl Watch Everything</div>
                <div class="text-xs text-gray-600 -mt-0.5">watch along with us â€¦</div>
              </div>
            </div>

            <div class="ml-auto flex items-center gap-2">
              <input id="search" placeholder="Search titleâ€¦" value="${escapeAttr(query)}" class="px-3 py-2 rounded-xl border w-64 focus:outline-none focus:ring" />
              ${unlocked ? '<button id="lock" class="px-3 py-2 rounded-xl border">ðŸ”“ Lock</button>' : '<button id="unlock" class="px-3 py-2 rounded-xl border">ðŸ”’ Unlock</button>'}
            </div>
          </div>
          <div class="max-w-7xl mx-auto px-4 pb-3 flex items-center gap-2">
            <button id="tab-movies"  class="px-3 py-2 rounded-xl border ${activeTab==='movies' ? 'bg-black text-white' : ''}">Movies</button>
            <button id="tab-ranked"  class="px-3 py-2 rounded-xl border ${activeTab==='ranked' ? 'bg-black text-white' : ''}">Ranked Compare</button>
            <button id="tab-podcast" class="px-3 py-2 rounded-xl border ${activeTab==='podcast'? 'bg-black text-white' : ''}">Podcast</button>
            ${unlocked ? `<button id="tab-editor" class="px-3 py-2 rounded-xl border ${activeTab==='editor' ? 'bg-black text-white' : ''}">Editors</button>` : ''}
          </div>
        </div>
        <main class="max-w-7xl mx-auto px-4 py-6" id="main"></main>
      `;

      qs('#search').addEventListener('input', e => { query = e.target.value; draw(); });
      const ub = qs('#unlock'); if (ub) ub.onclick = () => { const p = prompt('Enter password'); if (p===EDIT_PASSWORD){ unlocked=true; sessionStorage.setItem('jkwe_unlocked','1'); draw('editor'); } else { alert('Incorrect password'); } };
      const lb = qs('#lock');   if (lb) lb.onclick = () => { unlocked=false; sessionStorage.removeItem('jkwe_unlocked'); draw('movies'); };
      qs('#tab-movies').onclick  = ()=> draw('movies');
      qs('#tab-ranked').onclick  = ()=> draw('ranked');
      qs('#tab-podcast').onclick = ()=> draw('podcast');
      const tE = qs('#tab-editor'); if (tE) tE.onclick = ()=> draw('editor');

      draw(activeTab);
    }

    function filterMovies(list, q){
      const s = q.trim().toLowerCase();
      if (!s) return list;
      return list.filter(m => [m.title, String(m.year||''), m.director||'', m.producers||'', m.distributor||'']
        .filter(Boolean).some(t => String(t).toLowerCase().includes(s)));
    }

    function draw(tab){ if (tab) activeTab = tab; const main = qs('#main');
      const filtered = filterMovies(movies, query).slice().sort((a,b)=>a.title.localeCompare(b.title));
      if (activeTab==='movies')  main.replaceChildren(viewMovies(filtered));
      if (activeTab==='ranked')  main.replaceChildren(viewRankedCompare());
      if (activeTab==='podcast') main.replaceChildren(viewPodcast());
      if (activeTab==='editor')  main.replaceChildren(viewEditor());
    }

    /* =========================
       Movies grid (4 per row, bigger cards)
       ========================= */
    function viewMovies(list){
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
      const tpl = qs('#card-template');
      list.forEach(m => {
        const card = tpl.content.firstElementChild.cloneNode(true);
        const j = m.ratings?.jonathan ?? 'â€”';
        const k = m.ratings?.karl ?? 'â€”';
        card.querySelector('.jbadge').textContent = `J#${j}`;
        card.querySelector('.kbadge').textContent = `K#${k}`;

        const poster = card.querySelector('.poster');
        if (m.poster){ poster.src = m.poster; } else { poster.style.display='none'; }

        const title = card.querySelector('.title');
        const caption = `${m.title}${m.year?` <span class='text-gray-500 font-normal'>(${m.year})</span>`:''}`;
        title.innerHTML = m.imdbUrl
          ? `<a href="${m.imdbUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">${caption}</a>`
          : caption;

        const s = card.querySelector('.synopsis'); s.textContent = m.synopsis || '';
        card.querySelector('.meta-dir').textContent = 'Director: ' + (m.director || 'â€”');
        card.querySelector('.meta-prod').textContent = 'Producers: ' + (m.producers || 'â€”');
        card.querySelector('.meta-run').textContent  = 'Running time: ' + (m.runtimeMin ? (m.runtimeMin+' min') : 'â€”');
        card.querySelector('.meta-bud').textContent  = 'Budget: ' + (m.budget || 'â€”');
        card.querySelector('.meta-dist').textContent = 'Distributed by: ' + (m.distributor || 'â€”');

        const posterWrap = card.querySelector('.posterWrap');
        if (m.imdbUrl) {
          posterWrap.style.cursor = 'pointer';
          posterWrap.addEventListener('click', () => window.open(m.imdbUrl, '_blank', 'noopener'));
        }
        grid.appendChild(card);
      });
      return grid;
    }

    /* =========================
       Ranked Compare (locked to J_LIST & K_LIST)
       ========================= */
    function viewRankedCompare(){
      const wrap = document.createElement('div');
      wrap.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';

      function renderList(name, ORDER){
        const box = document.createElement('div');
        box.className = 'rounded-xl border p-4 bg-white';
        box.innerHTML = `<div class="font-semibold mb-3">${name}</div>`;

        const ol = document.createElement('ol');
        ol.className = 'space-y-2 list-decimal pl-5';

        ORDER.forEach((title, idx) => {
          const m = movies.find(x => (x.title || '').toLowerCase() === title.toLowerCase()) || { title };
          const topTen = (idx < 10) ? 'font-bold' : '';
          const anchor = m.imdbUrl
            ? `<a href="${m.imdbUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">${escapeHtml(m.title)}</a>`
            : escapeHtml(m.title);
          const year = m.year ? ` <span class="text-gray-500">(${m.year})</span>` : '';
          const li = document.createElement('li');
          li.innerHTML = `<span class="${topTen}">${anchor}${year}</span>`;
          ol.appendChild(li);
        });

        box.appendChild(ol);
        return box;
      }

      wrap.appendChild(renderList('Jonathanâ€™s Rankings', J_LIST));
      wrap.appendChild(renderList('Karlâ€™s Rankings', K_LIST));
      return wrap;
    }

    /* =========================
       Podcast tab (single clean card, wide/tall player)
       ========================= */
    function viewPodcast(){
      const box = document.createElement('div');
      box.className = 'space-y-4';

      const embed = getPodcastEmbed();

      const frameWrap = document.createElement('div');
      frameWrap.className = 'rounded-xl border bg-white overflow-hidden';
      frameWrap.innerHTML = `
        <div class="px-4 pt-4 pb-2 font-semibold">Listen to our podcast</div>
        ${embed
          ? `<iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
                    frameborder="0" height="520" style="width:100%;display:block"
                    sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
                    src="${escapeAttr(embed)}"></iframe>`
          : `<div class="px-4 pb-4 text-sm text-gray-600">No embed set. In <strong>Editors â†’ Podcast Settings</strong>, paste the Apple Podcasts <em>embed</em> URL (from Marketing Tools â†’ Share â†’ Embed Player).</div>`}
      `;
      box.appendChild(frameWrap);
      return box;
    }

    /* =========================
       Editors tab
       ========================= */
    function viewEditor(){
      const box = document.createElement('div');
      box.className = 'space-y-6';

      // Import/Export
      const ie = document.createElement('div');
      ie.className = 'rounded-xl border p-4';
      ie.innerHTML = `<div class="font-semibold mb-2">Data Management</div>
        <div class="flex items-center gap-2 mb-2">
          <button id="btn-import" class="px-3 py-2 rounded-xl border">Movie Import</button>
          <button id="btn-export" class="px-3 py-2 rounded-xl border">Movie Export</button>
        </div>`;
      box.appendChild(ie);

      // Add movie
      const add = document.createElement('div');
      add.className = 'rounded-xl border p-4 space-y-3';
      add.innerHTML = `
        <div class="font-semibold">Add a Movie</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="f-title" class="px-3 py-2 rounded-xl border" placeholder="Title"/>
          <input id="f-year"  class="px-3 py-2 rounded-xl border" placeholder="Year"/>
          <input id="f-j"     class="px-3 py-2 rounded-xl border" placeholder="Jonathan Rank (1=best)"/>
          <input id="f-k"     class="px-3 py-2 rounded-xl border" placeholder="Karl Rank (1=best)"/>
          <input id="f-poster" class="md:col-span-2 px-3 py-2 rounded-xl border" placeholder="Poster URL (or upload below)"/>
          <textarea id="f-syn" class="md:col-span-2 px-3 py-2 rounded-xl border" rows="2" placeholder="Synopsis"></textarea>
          <input id="f-imdb" class="md:col-span-2 px-3 py-2 rounded-xl border" placeholder="IMDb URL (for click-through & Fetch)"/>
          <input id="f-dir"  class="px-3 py-2 rounded-xl border" placeholder="Director"/>
          <input id="f-prod" class="px-3 py-2 rounded-xl border" placeholder="Producers (comma-separated)"/>
          <input id="f-run"  class="px-3 py-2 rounded-xl border" placeholder="Running time (min)"/>
          <input id="f-bud"  class="px-3 py-2 rounded-xl border" placeholder="Budget (e.g., 80 million USD)"/>
          <input id="f-dist" class="px-3 py-2 rounded-xl border" placeholder="Distributed by"/>
        </div>
        <div class="flex items-center gap-2">
          <input id="f-file" type="file" accept="image/*" class="hidden"/>
          <button id="f-upload" class="px-3 py-2 rounded-xl border">Upload Poster</button>
          <button id="f-add" class="px-3 py-2 rounded-xl border bg-black text-white">Add Movie</button>
          <img id="f-preview" class="h-14 w-10 object-cover rounded-md hidden" alt="preview"/>
        </div>`;
      box.appendChild(add);

      // Password Manager
      const pw = document.createElement('div');
      pw.className = 'rounded-xl border p-4 space-y-3';
      pw.innerHTML = `
        <div class="font-semibold">Password Management</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="pw-current" type="password" class="px-3 py-2 rounded-xl border" placeholder="Current password"/>
          <input id="pw-new" type="password" class="px-3 py-2 rounded-xl border" placeholder="New password"/>
          <input id="pw-confirm" type="password" class="px-3 py-2 rounded-xl border" placeholder="Confirm new password"/>
        </div>
        <div class="flex items-center gap-2">
          <button id="pw-save" class="px-3 py-2 rounded-xl border bg-black text-white">Change Password</button>
          <div id="pw-msg" class="text-sm text-gray-600"></div>
        </div>`;
      box.appendChild(pw);

      // OMDb Settings
      const omdb = document.createElement('div');
      omdb.className = 'rounded-xl border p-4 space-y-3';
      omdb.innerHTML = `
        <div class="font-semibold">OMDb Settings</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="omdb-key" class="px-3 py-2 rounded-xl border md:col-span-2" placeholder="OMDb API Key" />
          <button id="omdb-save" class="px-3 py-2 rounded-xl border bg-black text-white">Save Key</button>
        </div>
        <div class="text-sm text-gray-600">Key is stored locally in your browser.</div>
      `;
      box.appendChild(omdb);

      // Podcast Settings
      const pod = document.createElement('div');
      pod.className = 'rounded-xl border p-4 space-y-3';
      pod.innerHTML = `
        <div class="font-semibold">Podcast Settings</div>
        <p class="text-sm text-gray-600">Paste the Apple Podcasts <em>embed player URL</em> (from Apple Marketing Tools â†’ Share â†’ Embed Player). It should look like <code>https://embed.podcasts.apple.com/...</code>. Short links like <code>https://apple.co/...</code> wonâ€™t embed.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="pod-embed" class="px-3 py-2 rounded-xl border md:col-span-2" placeholder="https://embed.podcasts.apple.com/..."/>
          <button id="pod-save" class="px-3 py-2 rounded-xl border bg-black text-white">Save Embed</button>
        </div>`;
      box.appendChild(pod);

      // Edit existing list
      const editWrap = document.createElement('div');
      editWrap.className = 'rounded-xl border p-4 space-y-4';
      editWrap.innerHTML = `<div class="font-semibold">Edit Existing Movies</div>
        <input id="e-filter" class="px-3 py-2 rounded-xl border w-full md:w-96" placeholder="Filter by titleâ€¦" />
        <div id="e-list" class="space-y-4"></div>`;
      box.appendChild(editWrap);

      setTimeout(()=>{
        // Import/export
        qs('#btn-import').onclick = ()=> qs('#file-input').click();
        qs('#btn-export').onclick = handleExport;

        // Add movie fields & wires
        const fTitle=qs('#f-title'), fYear=qs('#f-year'), fJ=qs('#f-j'), fK=qs('#f-k'),
              fPoster=qs('#f-poster'), fSyn=qs('#f-syn'), fImdb=qs('#f-imdb'),
              fDir=qs('#f-dir'), fProd=qs('#f-prod'), fRun=qs('#f-run'), fBud=qs('#f-bud'), fDist=qs('#f-dist'),
              fFile=qs('#f-file'), fUpload=qs('#f-upload'), fAdd=qs('#f-add'), fPrev=qs('#f-preview');

        fUpload.onclick = () => fFile.click();
        fFile.onchange = (e)=>{ const file = e.target.files?.[0]; if(!file) return; const reader = new FileReader();
          reader.onload = ()=>{ fPoster.value = String(reader.result); fPrev.src = fPoster.value; fPrev.classList.remove('hidden'); };
          reader.readAsDataURL(file); e.target.value = '';
        };
        fPoster.oninput = ()=>{ const v=fPoster.value.trim(); if(v){ fPrev.src=v; fPrev.classList.remove('hidden'); } else { fPrev.classList.add('hidden'); } };

        fAdd.onclick = ()=>{
          const title = fTitle.value.trim(); if(!title) return alert('Enter a title.');
          const year = parseInt(fYear.value.trim(),10);
          const j = parseInt(fJ.value.trim(),10), k = parseInt(fK.value.trim(),10);
          const entry = {
            id: slugify(title + (Number.isFinite(year)?'-'+year:'')), title,
            year: Number.isFinite(year)? year: undefined,
            poster: fPoster.value.trim()||undefined,
            synopsis: fSyn.value.trim()||undefined,
            imdbUrl: fImdb.value.trim()||undefined,
            director: fDir.value.trim()||undefined,
            producers: fProd.value.trim()||undefined,
            runtimeMin: Number.isFinite(parseInt(fRun.value,10)) ? parseInt(fRun.value,10) : undefined,
            budget: fBud.value.trim()||undefined,
            distributor: fDist.value.trim()||undefined,
            ratings: { jonathan: Number.isFinite(j)? j: undefined, karl: Number.isFinite(k)? k: undefined }
          };
          movies.push(entry);
          alert('Movie added.');
          fTitle.value=fYear.value=fJ.value=fK.value=fPoster.value=fSyn.value=fImdb.value=fDir.value=fProd.value=fRun.value=fBud.value=fDist.value='';
          fPrev.classList.add('hidden');
          draw('movies'); renderEditorsList();
        };

        // Password update
        const pwCur=qs('#pw-current'), pwNew=qs('#pw-new'), pwCon=qs('#pw-confirm'), pwBtn=qs('#pw-save'), pwMsg=qs('#pw-msg');
        pwBtn.onclick = ()=>{
          if(pwCur.value !== EDIT_PASSWORD){ pwMsg.textContent = 'Current password is incorrect.'; pwMsg.className='text-sm text-red-600'; return; }
          if(!pwNew.value || pwNew.value !== pwCon.value){ pwMsg.textContent = 'New passwords do not match.'; pwMsg.className='text-sm text-red-600'; return; }
          setPassword(pwNew.value); EDIT_PASSWORD = getPassword(); pwCur.value=pwNew.value=pwCon.value='';
          pwMsg.textContent = 'Password updated.'; pwMsg.className='text-sm text-green-600';
        };

        // OMDb save/load
        const keyInput = qs('#omdb-key'); const keyBtn = qs('#omdb-save');
        if (keyInput) keyInput.value = getOmdbKey();
        if (keyBtn) keyBtn.onclick = ()=>{ setOmdbKey(keyInput.value.trim()); alert('OMDb key saved.'); };

        // Podcast save/load with simple validation
        const podInput = qs('#pod-embed'); const podBtn = qs('#pod-save');
        if (podInput) podInput.value = getPodcastEmbed();
        if (podBtn) podBtn.onclick = ()=>{
          const val = podInput.value.trim();
          if (val && !val.includes('embed.podcasts.apple.com')) {
            alert('This does not look like an Apple Podcasts EMBED URL. Use Apple Marketing Tools â†’ Share â†’ Embed Player and copy the src URL that starts with https://embed.podcasts.apple.com/');
          }
          setPodcastEmbed(val);
          alert('Podcast embed saved.');
        };

        // Render editors list
        function renderEditorsList(){
          const container = qs('#e-list');
          const filter = qs('#e-filter').value.trim().toLowerCase();
          container.innerHTML = '';
          movies.slice().sort((a,b)=>a.title.localeCompare(b.title)).forEach((m, idx)=>{
            if(filter && !m.title.toLowerCase().includes(filter)) return;
            const row = document.createElement('div');
            row.className = 'rounded-lg border p-3 grid grid-cols-1 md:grid-cols-6 gap-2 items-start';
            row.innerHTML = `
              <input class="e-title px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.title)}"/>
              <input class="e-year  px-2 py-1 rounded border" value="${m.year??''}" placeholder="Year"/>
              <input class="e-j     px-2 py-1 rounded border" value="${m.ratings?.jonathan??''}" placeholder="J Rank"/>
              <input class="e-k     px-2 py-1 rounded border" value="${m.ratings?.karl??''}" placeholder="K Rank"/>
              <input class="e-imdb  px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.imdbUrl||'')}" placeholder="IMDb URL"/>
              <button type="button" class="fetch px-2 py-1 rounded border text-xs md:col-span-1">Fetch IMDb</button>
              <input class="e-poster px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.poster||'')}" placeholder="Poster URL"/>
              <input class="e-dir   px-2 py-1 rounded border" value="${escapeAttr(m.director||'')}" placeholder="Director"/>
              <input class="e-prod  px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.producers||'')}" placeholder="Producers"/>
              <input class="e-run   px-2 py-1 rounded border" value="${m.runtimeMin??''}" placeholder="Runtime (min)"/>
              <input class="e-bud   px-2 py-1 rounded border" value="${escapeAttr(m.budget||'')}" placeholder="Budget"/>
              <input class="e-dist  px-2 py-1 rounded border" value="${escapeAttr(m.distributor||'')}" placeholder="Distributed by"/>
              <textarea class="e-syn px-2 py-1 rounded border md:col-span-6" rows="2" placeholder="Synopsis">${m.synopsis?escapeHtml(m.synopsis):''}</textarea>
              <div class="md:col-span-6 flex gap-2 justify-end">
                <button class="save px-3 py-1 rounded border bg-black text-white">Save</button>
                <button class="del px-3 py-1 rounded border">Delete</button>
              </div>`;
            row.querySelector('.save').onclick = ()=>{
              const g = sel=>row.querySelector(sel);
              m.title = g('.e-title').value.trim()||m.title;
              const ny = parseInt(g('.e-year').value,10); m.year = Number.isFinite(ny)? ny: undefined;
              const nj = parseInt(g('.e-j').value,10); m.ratings = m.ratings || {}; if(Number.isFinite(nj)) m.ratings.jonathan = nj; else delete m.ratings.jonathan;
              const nk = parseInt(g('.e-k').value,10); m.ratings = m.ratings || {}; if(Number.isFinite(nk)) m.ratings.karl = nk; else delete m.ratings.karl;
              m.imdbUrl = g('.e-imdb').value.trim()||undefined;
              m.poster  = g('.e-poster').value.trim()||undefined;
              m.director= g('.e-dir').value.trim()||undefined;
              m.producers=g('.e-prod').value.trim()||undefined;
              const rn = parseInt(g('.e-run').value,10); m.runtimeMin = Number.isFinite(rn)? rn: undefined;
              m.budget = g('.e-bud').value.trim()||undefined;
              m.distributor = g('.e-dist').value.trim()||undefined;
              m.synopsis = g('.e-syn').value.trim()||undefined;
              m.id = slugify(m.title + (m.year?'-'+m.year:''));
              alert('Saved.');
              draw(activeTab);
            };
            row.querySelector('.del').onclick = ()=>{
              if(confirm('Delete this title?')){ movies.splice(idx,1); renderEditorsList(); draw(activeTab); }
            };
            const fetchBtn = row.querySelector('.fetch');
            if (fetchBtn) {
              fetchBtn.onclick = () => {
                const url = row.querySelector('.e-imdb')?.value?.trim();
                fetchIMDbData(url, row);
              };
            }
            container.appendChild(row);
          });
        }
        qs('#e-filter').addEventListener('input', renderEditorsList);
        renderEditorsList();
      }, 0);

      return box;
    }

    /* =========================
       Import / Export
       ========================= */
    const fileInput = qs('#file-input');
    function handleExport(){
      const payload = JSON.stringify({ movies }, null, 2);
      const blob = new Blob([payload], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'JKWE-Rankings-' + new Date().toISOString().slice(0,10) + '.json';
      a.click(); URL.revokeObjectURL(url);
    }
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result));
          const next = Array.isArray(parsed) ? parsed : parsed.movies;
          if (!Array.isArray(next)) throw new Error('Bad structure');
          movies = next; draw('movies');
        } catch (err) {
          alert('Unable to parse JSON. Expect an array of movies or { movies: [...] }');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    /* =========================
       Boot
       ========================= */
    render();
  </script>
</body>
</html>
