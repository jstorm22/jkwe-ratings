<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jonathan & Karl Watch Everything: Movies and Television</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tabular-nums { font-variant-numeric: tabular-nums; }
    .line-clamp-5 { display:-webkit-box; -webkit-line-clamp:5; -webkit-box-orient:vertical; overflow:hidden; }
    .badge { font-size:10px; line-height:1; padding:.25rem .5rem; border-radius:9999px; background:rgba(0,0,0,.75); color:#fff; }
    .poster-ghost { background: linear-gradient(180deg,#f3f4f6 0%,#e5e7eb 100%); }
  </style>
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div id="app"></div>

  <!-- Card templates -->
  <template id="card-template">
    <div class="group rounded-2xl border overflow-hidden shadow-sm hover:shadow-lg transition relative">
      <div class="absolute top-2 left-2 z-10 flex gap-1">
        <span class="j badge"></span>
      </div>
      <div class="absolute top-2 right-2 z-10 flex gap-1">
        <span class="k badge"></span>
      </div>
      <a class="block posterWrap aspect-[2/3] overflow-hidden poster-ghost" target="_blank" rel="noopener">
        <img class="w-full h-full object-cover group-hover:scale-[1.02] transition hidden" alt="poster" />
      </a>
      <div class="p-4 space-y-2">
        <div class="title text-lg font-semibold leading-tight"></div>
        <p class="synopsis text-sm text-gray-700 line-clamp-5"></p>
        <div class="hovermeta text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition"></div>
      </div>
    </div>
  </template>

  <template id="rank-row-template">
    <tr class="border-b last:border-none">
      <td class="px-3 py-3">
        <div class="flex items-center gap-3">
          <img class="thumb w-10 h-14 object-cover rounded-md hidden" alt="poster" />
          <div>
            <div class="t font-medium leading-tight"></div>
          </div>
        </div>
      </td>
      <td class="px-3 py-3 tabular-nums font-semibold jrank"></td>
      <td class="px-3 py-3 tabular-nums font-semibold krank"></td>
      <td class="px-3 py-3 tabular-nums jrate"></td>
      <td class="px-3 py-3 tabular-nums krate"></td>
    </tr>
  </template>

  <!-- Unlock Modal -->
  <div id="unlock-overlay" class="hidden fixed inset-0 z-50 bg-black/40 items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 space-y-4">
      <div class="text-lg font-semibold">Unlock Editor</div>
      <p class="text-sm text-gray-600">Enter the editor password to access the Editors tab.</p>
      <input id="pw-input" type="password" placeholder="Enter password" class="w-full px-3 py-2 rounded-xl border focus:outline-none focus:ring" />
      <div id="pw-error" class="text-sm text-red-600 hidden">Incorrect password. Try again.</div>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button id="btn-cancel" class="px-3 py-2 rounded-xl border">Cancel</button>
        <button id="btn-apply" class="px-3 py-2 rounded-xl border bg-black text-white">Unlock</button>
      </div>
    </div>
  </div>

  <input id="file-input" type="file" accept="application/json" class="hidden" />

  <script>
    // ====== Cloud endpoints (Vercel serverless) ======
    const API_SETTINGS = '/api/gh?kind=settings';
    const API_MOVIES   = '/api/gh?kind=movies';

    // ====== App State ======
    let unlocked = sessionStorage.getItem('cs_unlocked') === '1';
    let activeTab = 'movies'; // movies | ranked | podcast | editor
    let query = '';
    let settings = { podcastEmbed: '', editPassword: 'sage42' };
    let settingsSha = null;
    let movies = [];
    let moviesSha = null;

    // ====== Utilities ======
    const qs  = (s, r=document)=> r.querySelector(s);
    const qsa = (s, r=document)=> Array.from(r.querySelectorAll(s));
    const app = qs('#app');

    function html(strings, ...vals){ return strings.map((s,i)=>s+(vals[i]??'')).join(''); }
    function escapeAttr(v){ return String(v).replace(/"/g,'&quot;'); }
    function filterMovies(list, q) {
      const s = q.trim().toLowerCase();
      if(!s) return list;
      return list.filter(m => [ m.title, String(m.year||''), m.director||'', ...(m.genres||[]), ...(m.cast||[]) ]
        .filter(Boolean).some(t => String(t).toLowerCase().includes(s)));
    }
    function denseRanks(list, who) {
      const rated = list.map(m => ({ id:m.id, score: (m.ratings && typeof m.ratings[who]==='number') ? m.ratings[who] : null }))
        .filter(x=>x.score!=null);
      rated.sort((a,b)=>b.score-a.score);
      const map = new Map(); let rank=0, prev=null;
      rated.forEach(r=>{ if(prev===null || r.score!==prev){ rank+=1; prev=r.score; } map.set(r.id, rank); });
      return map;
    }
    function scrollTopNow(){
      // Fix: jump to top whenever switching tabs to avoid mid-page starts
      window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
      const main = qs('main');
      if (main) main.scrollIntoView({ block: 'start' });
    }

    // ====== Cloud I/O ======
    async function loadSettings(){
      const r = await fetch(API_SETTINGS, { method:'GET' });
      if(!r.ok){ console.warn('settings GET failed'); return; }
      const j = await r.json();
      settingsSha = j.sha || null;
      try { settings = JSON.parse(j.json || '{}'); } catch { settings = {}; }
      if (!settings) settings = {};
      if (!settings.editPassword) settings.editPassword = 'sage42';
      if (!settings.podcastEmbed) settings.podcastEmbed = '';
    }
    async function saveSettings(next){
      const payload = JSON.stringify(next, null, 2);
      const r = await fetch(API_SETTINGS, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ json: payload, sha: settingsSha, message:'Update settings.json' })
      });
      if(!r.ok){ alert('Failed to save settings'); return false; }
      const j = await r.json();
      settingsSha = j.sha || settingsSha;
      settings = next;
      return true;
    }

    async function loadMovies(){
      const r = await fetch(API_MOVIES, { method:'GET' });
      if(!r.ok){ console.warn('movies GET failed'); return; }
      const j = await r.json();
      moviesSha = j.sha || null;
      try { movies = JSON.parse(j.json || '[]'); } catch { movies = []; }
      if(!Array.isArray(movies)) movies = [];
    }
    async function saveMovies(next){
      const payload = JSON.stringify(next, null, 2);
      const r = await fetch(API_MOVIES, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ json: payload, sha: moviesSha, message:'Update movies.json' })
      });
      if(!r.ok){ alert('Failed to save movies'); return false; }
      const j = await r.json();
      moviesSha = j.sha || moviesSha;
      movies = next;
      return true;
    }

    // ====== Render ======
    function render(){
      app.innerHTML = '';

      // Header
      const top = document.createElement('div');
      top.className = 'sticky top-0 z-40 backdrop-blur bg-white/70 border-b';
      top.innerHTML = html`
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <!-- JKWE logo block -->
          <div class="flex items-center gap-1">
            <div class="w-8 h-8 rounded-md bg-orange-500 text-white grid place-items-center font-extrabold">J</div>
            <div class="w-8 h-8 rounded-md bg-orange-500 text-white grid place-items-center font-extrabold">K</div>
            <div class="w-8 h-8 rounded-md bg-orange-500 text-white grid place-items-center font-extrabold">W</div>
            <div class="w-8 h-8 rounded-md bg-orange-500 text-white grid place-items-center font-extrabold">E</div>
          </div>
          <div class="leading-tight">
            <div class="text-lg sm:text-xl font-semibold">Jonathan & Karl Watch Everything: Movies and Television</div>
            <div class="text-[12px] text-gray-500 -mt-0.5">watch along with us â€¦</div>
          </div>

          <div class="ml-auto flex items-center gap-2">
            <input id="search" placeholder="Search title..." value="${escapeAttr(query)}" class="px-3 py-2 rounded-xl border w-64 focus:outline-none focus:ring" />
            ${!unlocked
              ? '<button id="unlock" class="px-3 py-2 rounded-xl border hover:shadow" title="Unlock editor">ðŸ”’ Unlock</button>'
              : '<button id="lock" class="px-3 py-2 rounded-xl border hover:shadow" title="Lock editor">ðŸ”“ Lock</button>'}
          </div>
        </div>
        <div class="max-w-6xl mx-auto px-4 pb-3 flex items-center gap-2">
          <button id="tab-movies"   class="px-3 py-2 rounded-xl border ${activeTab==='movies' ? 'bg-black text-white' : ''}">Movies</button>
          <button id="tab-ranked"   class="px-3 py-2 rounded-xl border ${activeTab==='ranked' ? 'bg-black text-white' : ''}">Ranked List</button>
          <button id="tab-podcast"  class="px-3 py-2 rounded-xl border ${activeTab==='podcast'? 'bg-black text-white' : ''}">Podcast</button>
          ${unlocked ? `<button id="tab-editor" class="px-3 py-2 rounded-xl border ${activeTab==='editor' ? 'bg-black text-white' : ''}">Editors</button>` : ''}
        </div>`;
      app.appendChild(top);

      // Main
      const main = document.createElement('main');
      main.className = 'max-w-6xl mx-auto px-4 py-6 space-y-6';

      const filtered = filterMovies(movies, query);
      const jranks = denseRanks(filtered, 'jonathan');
      const kranks = denseRanks(filtered, 'karl');

      if (activeTab === 'movies') {
        main.appendChild(renderPublicGrid(filtered, jranks, kranks));
      } else if (activeTab === 'ranked') {
        main.appendChild(renderRanked(filtered, jranks, kranks));
      } else if (activeTab === 'podcast') {
        main.appendChild(renderPodcast());
      } else if (activeTab === 'editor' && unlocked) {
        main.appendChild(renderEditors());
      }
      app.appendChild(main);

      // wire
      qs('#search').addEventListener('input', (e) => { query = e.target.value; render(); });
      const unlockBtn = qs('#unlock');
      if (unlockBtn) unlockBtn.addEventListener('click', openUnlock);
      const lockBtn = qs('#lock');
      if (lockBtn) lockBtn.addEventListener('click', () => { sessionStorage.removeItem('cs_unlocked'); unlocked = false; activeTab = 'movies'; render(); });

      qs('#tab-movies').addEventListener('click', () => { activeTab='movies'; render(); scrollTopNow(); });
      qs('#tab-ranked').addEventListener('click', () => { activeTab='ranked'; render(); scrollTopNow(); });
      qs('#tab-podcast').addEventListener('click', () => { activeTab='podcast'; render(); scrollTopNow(); });
      const tabEditor = qs('#tab-editor');
      if (tabEditor) tabEditor.addEventListener('click', () => { activeTab='editor'; render(); scrollTopNow(); });
    }

    function renderPublicGrid(list, jranks, kranks){
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
      const tpl = qs('#card-template');
      list.forEach(m=>{
        const node = tpl.content.firstElementChild.cloneNode(true);
        // badges
        node.querySelector('.j').textContent = 'J#' + (jranks.get(m.id) ?? 'â€”');
        node.querySelector('.k').textContent = 'K#' + (kranks.get(m.id) ?? 'â€”');

        // poster + IMDb link
        const wrap = node.querySelector('.posterWrap');
        const img = wrap.querySelector('img');
        if (m.poster) {
          img.src = m.poster; img.classList.remove('hidden');
          img.onerror = () => { img.classList.add('hidden'); };
        }
        wrap.href = m.imdbUrl || '#';

        // title/year
        node.querySelector('.title').innerHTML = `${m.title} ${m.year ? `<span class="text-gray-500 font-normal">(${m.year})</span>` : ''}`;

        // synopsis
        const s = node.querySelector('.synopsis');
        if (m.synopsis) s.textContent = m.synopsis; else s.remove();

        // hover meta (Director â†’ Cast â†’ Runtime)
        const meta = [];
        if (m.director) meta.push(`Director: ${m.director}`);
        if (m.cast && m.cast.length) meta.push(`Cast: ${m.cast.slice(0,4).join(', ')}`);
        if (m.runtimeMin) meta.push(`Runtime: ${m.runtimeMin} min`);
        node.querySelector('.hovermeta').innerHTML = meta.join('<br/>');

        grid.appendChild(node);
      });
      return grid;
    }

    function renderRanked(list, jranks, kranks){
      // two-column compare, bold top-10 each side
      const wrap = document.createElement('div');
      wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';

      const left = document.createElement('div');
      left.className = 'rounded-2xl border p-4';
      left.innerHTML = `<div class="font-semibold mb-3">Jonathanâ€™s Rankings</div>`;
      const l = document.createElement('ol'); l.className = 'space-y-1 list-decimal list-inside';
      // sort by Jonathan rank
      const byJ = [...list].sort((a,b)=>(jranks.get(a.id)||999)-(jranks.get(b.id)||999));
      byJ.forEach(m=>{
        const r = jranks.get(m.id) ?? 'â€”';
        const li = document.createElement('li');
        li.innerHTML = `<span class="${(typeof r==='number' && r<=10)?'font-semibold':''}">${m.title}</span>`;
        l.appendChild(li);
      });
      left.appendChild(l);

      const right = document.createElement('div');
      right.className = 'rounded-2xl border p-4';
      right.innerHTML = `<div class="font-semibold mb-3">Karlâ€™s Rankings</div>`;
      const rlist = document.createElement('ol'); rlist.className = 'space-y-1 list-decimal list-inside';
      const byK = [...list].sort((a,b)=>(kranks.get(a.id)||999)-(kranks.get(b.id)||999));
      byK.forEach(m=>{
        const r = kranks.get(m.id) ?? 'â€”';
        const li = document.createElement('li');
        li.innerHTML = `<span class="${(typeof r==='number' && r<=10)?'font-semibold':''}">${m.title}</span>`;
        rlist.appendChild(li);
      });
      right.appendChild(rlist);

      wrap.appendChild(left); wrap.appendChild(right);
      return wrap;
    }

    function sanitizeEmbed(raw){
      // Force responsive size and remove max-width:660px etc
      if(!raw) return '';
      let out = raw.replace(/max-width\s*:\s*\d+px;?/ig, '')
                   .replace(/width\s*=\s*"(?!100%)[^"]*"/ig, 'width="100%"')
                   .replace(/style="([^"]*)"/i, (m, s) => {
                      // Ensure width:100%; height:450px; border-radius
                      let css = s;
                      css = css.replace(/max-width\s*:\s*[^;]+;?/ig,'');
                      css = css.replace(/width\s*:\s*[^;]+;?/ig,'');
                      return `style="${css}; width:100%; height:450px; border:0; border-radius:12px"`;
                    });
      // fallback if no style attr present
      if(!/style="/i.test(out)){
        out = out.replace(/<iframe/i, '<iframe style="width:100%; height:450px; border:0; border-radius:12px"');
      }
      return out;
    }

    function renderPodcast(){
      const wrap = document.createElement('div');
      wrap.className = 'rounded-2xl border p-4';
      const embed = sanitizeEmbed(settings.podcastEmbed || '');
      wrap.innerHTML = `
        <div class="text-base font-semibold mb-3">Listen to our podcast</div>
        <div class="bg-white rounded-xl overflow-hidden">
          ${embed || '<div class="text-sm text-gray-500 p-4">Paste your Apple Podcasts embed in the Editors tab and Save.</div>'}
        </div>`;
      return wrap;
    }

    function renderEditors(){
      const box = document.createElement('div');
      box.className = 'space-y-6';

      // Password + Podcast
      const sec = document.createElement('div');
      sec.className = 'rounded-2xl border p-4 space-y-3';
      sec.innerHTML = `
        <div class="font-semibold">Settings</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Current password</label>
            <input id="pw-current" type="password" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div>
            <label class="text-sm text-gray-600">New password</label>
            <input id="pw-new" type="password" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-600">Confirm new password</label>
            <input id="pw-confirm" type="password" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div class="md:col-span-2 flex items-center gap-2">
            <button id="btn-save-pw" class="px-3 py-2 rounded-xl border bg-black text-white">Change Password</button>
            <div id="pw-msg" class="text-sm text-gray-600"></div>
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-600">Podcast Embed (paste the full &lt;iframe&gt; from Apple)</label>
            <textarea id="podcast-embed" rows="5" class="w-full px-3 py-2 rounded-xl border" placeholder="<iframe ...>"></textarea>
          </div>
          <div class="md:col-span-2 flex items-center gap-2">
            <button id="btn-save-embed" class="px-3 py-2 rounded-xl border bg-black text-white">Save Podcast</button>
            <div id="embed-msg" class="text-sm text-gray-600"></div>
          </div>
        </div>`;
      box.appendChild(sec);

      // Movies editor
      const card = document.createElement('div');
      card.className = 'rounded-2xl border p-4';
      card.innerHTML = `<div class="font-semibold mb-2">Edit Existing Movies</div>
        <input id="filter" class="w-full mb-3 px-3 py-2 rounded-xl border" placeholder="Filter by title..."/>
        <div id="m-list" class="space-y-4"></div>`;
      box.appendChild(card);

      // Wire up initial values
      setTimeout(()=>{
        qs('#podcast-embed').value = settings.podcastEmbed || '';
        qs('#btn-save-embed').onclick = async ()=>{
          const next = { ...settings, podcastEmbed: qs('#podcast-embed').value.trim() };
          const ok = await saveSettings(next);
          qs('#embed-msg').textContent = ok ? 'Podcast saved.' : 'Save failed.';
          if(ok){ render(); }
        };

        qs('#btn-save-pw').onclick = async ()=>{
          const cur = qs('#pw-current').value;
          const nv  = qs('#pw-new').value;
          const cf  = qs('#pw-confirm').value;
          const msg = qs('#pw-msg');
          if (cur !== settings.editPassword) { msg.textContent='Current password is incorrect.'; return; }
          if (nv !== cf || nv.length < 4) { msg.textContent='New passwords do not match (min 4 chars).'; return; }
          const ok = await saveSettings({ ...settings, editPassword: nv });
          msg.textContent = ok ? 'Password updated.' : 'Save failed.';
        };

        // render movie rows
        renderEditorMovieRows();
      });

      return box;
    }

    function renderEditorMovieRows(){
      const container = qs('#m-list');
      const filter = qs('#filter').value.trim().toLowerCase();
      container.innerHTML = '';
      movies.slice().sort((a,b)=>a.title.localeCompare(b.title)).forEach((m, idx)=>{
        if (filter && !m.title.toLowerCase().includes(filter)) return;
        const row = document.createElement('div');
        row.className = 'rounded-lg border p-3 grid grid-cols-1 md:grid-cols-6 gap-2 items-start';
        row.innerHTML = `
          <input class="px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.title||'')}" placeholder="Title"/>
          <input class="px-2 py-1 rounded border" value="${escapeAttr(m.year||'')}" placeholder="Year"/>
          <input class="px-2 py-1 rounded border" value="${(m.ratings && m.ratings.jonathan!=null)?m.ratings.jonathan:''}" placeholder="Jonathan Rank"/>
          <input class="px-2 py-1 rounded border" value="${(m.ratings && m.ratings.karl!=null)?m.ratings.karl:''}" placeholder="Karl Rank"/>
          <input class="px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.imdbUrl||'')}" placeholder="IMDb URL"/>
          <button class="fetch px-3 py-2 rounded-xl border">Fetch IMDb</button>
          <input class="px-2 py-1 rounded border md:col-span-2" value="${escapeAttr(m.poster||'')}" placeholder="Poster URL"/>
          <input class="px-2 py-1 rounded border" value="${escapeAttr(m.director||'')}" placeholder="Director"/>
          <input class="px-2 py-1 rounded border" value="${escapeAttr((m.cast||[]).join(', '))}" placeholder="Actors (comma-separated)"/>
          <input class="px-2 py-1 rounded border" value="${escapeAttr(m.runtimeMin||'')}" placeholder="Runtime (min)"/>
          <textarea class="px-2 py-1 rounded border md:col-span-5" placeholder="Synopsis">${m.synopsis?escapeAttr(m.synopsis):''}</textarea>
          <div class="md:col-span-1 flex items-center gap-2 justify-end">
            <button class="save px-3 py-2 rounded-xl border bg-black text-white">Save</button>
            <button class="del px-3 py-2 rounded-xl border">Delete</button>
          </div>`;
        container.appendChild(row);

        const [titleEl, yearEl, jEl, kEl, imdbEl, fetchBtn, posterEl, dirEl, castEl, runEl, synEl] =
          qsa('input,button.fetch,input,input,input,button.fetch + input,input,input,input,textarea', row);

        fetchBtn.onclick = async ()=>{
          const url = imdbEl.value.trim();
          if(!url){ alert('Paste an IMDb title URL first'); return; }
          // Simple pattern: try OMDb by IMDb id, else try by title+year
          const imdbIdMatch = url.match(/tt\d{7,}/);
          let data = null;
          try{
            // Use your proxy API if you added one; otherwise call OMDb with your key in env (server side).
            const proxy = `/api/omdb?imdb=${imdbIdMatch?imdbIdMatch[0]:''}&title=${encodeURIComponent(titleEl.value||'')}&year=${encodeURIComponent(yearEl.value||'')}`;
            const r = await fetch(proxy);
            if(r.ok) data = await r.json();
          }catch(e){}
          if(!data || data.Error){ alert('Could not fetch from OMDb. You can paste fields manually.'); return; }
          titleEl.value = data.Title || titleEl.value;
          yearEl.value  = data.Year || yearEl.value;
          posterEl.value = data.Poster && data.Poster!=='N/A' ? data.Poster : posterEl.value;
          dirEl.value   = data.Director && data.Director!=='N/A' ? data.Director : dirEl.value;
          castEl.value  = data.Actors && data.Actors!=='N/A' ? data.Actors : castEl.value;
          runEl.value   = data.Runtime ? (parseInt(data.Runtime,10)||'') : runEl.value;
          synEl.value   = data.Plot && data.Plot!=='N/A' ? data.Plot : synEl.value;
        };

        row.querySelector('.save').onclick = async ()=>{
          const updated = { ...m };
          updated.title = titleEl.value.trim();
          updated.year  = Number(yearEl.value)||null;
          updated.imdbUrl = imdbEl.value.trim()||'';
          updated.poster = posterEl.value.trim()||'';
          updated.director = dirEl.value.trim()||'';
          updated.cast = castEl.value.split(',').map(s=>s.trim()).filter(Boolean);
          updated.runtimeMin = Number(runEl.value)||null;
          updated.synopsis = synEl.value.trim();
          updated.ratings = {
            jonathan: jEl.value===''? null : Number(jEl.value),
            karl:     kEl.value===''? null : Number(kEl.value)
          };
          if(!updated.id) updated.id = (updated.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
          const next = movies.slice();
          next[idx] = updated;
          const ok = await saveMovies(next);
          if(ok){ alert('Saved'); render(); }
        };

        row.querySelector('.del').onclick = async ()=>{
          if(!confirm(`Delete "${m.title}"?`)) return;
          const next = movies.filter((_,i)=>i!==idx);
          const ok = await saveMovies(next);
          if(ok){ render(); }
        };
      });

      qs('#filter').oninput = ()=> renderEditorMovieRows();
    }

    // ====== Unlock modal controls ======
    function openUnlock() {
      const overlay = qs('#unlock-overlay');
      const input = qs('#pw-input');
      const err = qs('#pw-error');
      const btnCancel = qs('#btn-cancel');
      const btnApply = qs('#btn-apply');
      overlay.classList.remove('hidden');
      overlay.classList.add('flex');
      input.value = '';
      input.focus();
      err.classList.add('hidden');

      function close(){ overlay.classList.add('hidden'); overlay.classList.remove('flex');
        btnApply.removeEventListener('click', onApply); btnCancel.removeEventListener('click', onCancel); input.removeEventListener('keydown', onKey); }
      function onCancel(){ close(); }
      function onApply(){
        if (input.value.trim() === settings.editPassword) {
          sessionStorage.setItem('cs_unlocked','1'); unlocked = true; activeTab='editor'; close(); render();
        } else { err.classList.remove('hidden'); }
      }
      function onKey(e){ if(e.key==='Enter') onApply(); if(e.key==='Escape') onCancel(); }
      btnCancel.addEventListener('click', onCancel);
      btnApply.addEventListener('click', onApply);
      input.addEventListener('keydown', onKey);
    }

    // ====== Boot ======
    (async function init(){
      // Load from cloud, then render
      await Promise.all([loadSettings(), loadMovies()]);
      // honor ?tab= if needed
      const tab = new URLSearchParams(location.search).get('tab');
      if (tab && ['movies','ranked','podcast','editor'].includes(tab)) activeTab = tab;
      render();
    })();
  </script>
</body>
</html>
