<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jonathan & Karl Watch Everything: Movies and Television</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tabular-nums { font-variant-numeric: tabular-nums; }
    .line-clamp-6 { display:-webkit-box; -webkit-line-clamp:6; -webkit-box-orient:vertical; overflow:hidden; }
    .badge { font-size:10px; padding:2px 6px; border-radius:999px; background:rgba(0,0,0,.8); color:#fff; }
    .badge-light { background:rgba(0,0,0,.6); }
    .poster-skeleton { background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%); background-size:400% 100%; animation:shimmer 1.4s ease infinite; }
    @keyframes shimmer { 0% {background-position:100% 0} 100% {background-position:-100% 0} }
  </style>
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div id="app"></div>

  <!-- Templates -->
  <template id="card-template">
    <div class="group rounded-2xl border overflow-hidden shadow-sm hover:shadow-lg transition relative">
      <div class="ranks absolute top-2 left-2 right-2 flex justify-between z-10 px-2"></div>
      <a class="block posterWrap aspect-[2/3] overflow-hidden bg-gray-100 poster-skeleton" target="_blank" rel="noopener"></a>
      <div class="p-4 space-y-2">
        <div class="title text-lg font-semibold leading-tight"></div>
        <p class="synopsis text-sm text-gray-700 line-clamp-6"></p>
        <div class="hovermeta text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition"></div>
      </div>
    </div>
  </template>

  <!-- Unlock overlay -->
  <div id="unlock-overlay" class="hidden fixed inset-0 z-50 bg-black/40 items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 space-y-4">
      <div class="text-lg font-semibold">Unlock Editors</div>
      <p class="text-sm text-gray-600">Enter the editor password.</p>
      <input id="pw-input" type="password" placeholder="Enter password" class="w-full px-3 py-2 rounded-xl border focus:outline-none focus:ring" />
      <div id="pw-error" class="text-sm text-red-600 hidden">Incorrect password. Try again.</div>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button id="btn-cancel" class="px-3 py-2 rounded-xl border">Cancel</button>
        <button id="btn-apply" class="px-3 py-2 rounded-xl border bg-black text-white">Unlock</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Cloud state ----------
    let movies = [];                         // array of movie objects
    let SITE = { podcastEmbed: '', editPassword: 'sage42', omdbKey: '' }; // site-level settings
    let CLOUD_SHAS = { movies: null, site: null };

    // UI state
    let unlocked = false;
    let activeTab = 'movies'; // 'movies' | 'ranked' | 'podcast' | 'editors'
    let query = '';

    // Helpers
    const app = sel => document.querySelector(sel);
    const tpl = id => document.getElementById(id);
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const esc = s => String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    // ---------- Cloud IO ----------
    async function loadFromCloud() {
      const r = await fetch('/api/load');
      if (!r.ok) throw new Error('Cloud load failed');
      const j = await r.json();
      CLOUD_SHAS = j.shas || {};
      return { movies: j.movies || [], site: j.site || { podcastEmbed:'', editPassword:'sage42', omdbKey:'' } };
    }
    async function saveToCloud(nextMovies, nextSite) {
      const r = await fetch('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ movies: nextMovies, site: nextSite, shas: CLOUD_SHAS })
      });
      if (!r.ok) {
        const t = await r.text();
        throw new Error('Cloud save failed: ' + t);
      }
      const j = await r.json();
      CLOUD_SHAS = j.newShas || CLOUD_SHAS;
    }

    // ---------- Ranking helpers ----------
    // jonathan/karl rank fields: m.ratings?.jonathanRank, m.ratings?.karlRank
    function rankMap(list, who='jonathanRank') {
      const m = new Map();
      list.forEach(x => {
        const r = x.ratings && Number.isFinite(+x.ratings[who]) ? +x.ratings[who] : null;
        if (r != null) m.set(x.id, r);
      });
      return m;
    }

    // ---------- Render ----------
    function render() {
      const root = document.getElementById('app');
      root.innerHTML = '';

      // Header
      const header = document.createElement('div');
      header.className = 'sticky top-0 z-40 backdrop-blur bg-white/80 border-b';
      header.innerHTML = `
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <div class="flex items-center gap-2">
            <div class="flex gap-1">
              <div class="w-6 h-6 rounded-md bg-orange-500 text-white grid place-content-center text-[11px] font-bold">J</div>
              <div class="w-6 h-6 rounded-md bg-orange-500 text-white grid place-content-center text-[11px] font-bold">K</div>
              <div class="w-6 h-6 rounded-md bg-orange-500 text-white grid place-content-center text-[11px] font-bold">W</div>
              <div class="w-6 h-6 rounded-md bg-orange-500 text-white grid place-content-center text-[11px] font-bold">E</div>
            </div>
            <div>
              <div class="text-base sm:text-lg font-semibold leading-tight">Jonathan & Karl Watch Everything: Movies and Television</div>
              <div class="text-xs text-gray-500 -mt-0.5">watch along with us â€¦</div>
            </div>
          </div>
          <div class="ml-auto flex items-center gap-2">
            <input id="search" placeholder="Search title..." value="${esc(query)}" class="px-3 py-2 rounded-xl border w-64 focus:outline-none focus:ring" />
            ${!unlocked
              ? '<button id="unlock" class="px-3 py-2 rounded-xl border hover:shadow" title="Unlock editor">ðŸ”’ Unlock</button>'
              : '<button id="lock" class="px-3 py-2 rounded-xl border hover:shadow" title="Lock editor">ðŸ”“ Lock</button>'}
          </div>
        </div>
        <div class="max-w-6xl mx-auto px-4 pb-3 flex items-center gap-2">
          <button data-tab="movies" class="tab px-3 py-2 rounded-xl border ${activeTab==='movies'?'bg-black text-white':''}">Movies</button>
          <button data-tab="ranked" class="tab px-3 py-2 rounded-xl border ${activeTab==='ranked'?'bg-black text-white':''}">Ranked List</button>
          <button data-tab="podcast" class="tab px-3 py-2 rounded-xl border ${activeTab==='podcast'?'bg-black text-white':''}">Podcast</button>
          ${unlocked ? `<button data-tab="editors" class="tab px-3 py-2 rounded-xl border ${activeTab==='editors'?'bg-black text-white':''}">Editors</button>` : ''}
        </div>`;
      root.appendChild(header);

      const main = document.createElement('main');
      main.className = 'max-w-6xl mx-auto px-4 py-6 space-y-6';

      // Filtered list
      const s = query.trim().toLowerCase();
      const filtered = s
        ? movies.filter(m => [m.title, String(m.year||''), m.director||'', ...(m.genres||[]), ...(m.cast||[])].filter(Boolean).some(t => String(t).toLowerCase().includes(s)))
        : movies.slice();

      const jRankMap = rankMap(filtered, 'jonathanRank');
      const kRankMap = rankMap(filtered, 'karlRank');

      if (activeTab === 'movies') {
        main.appendChild(renderMovies(filtered, jRankMap, kRankMap));
      } else if (activeTab === 'ranked') {
        main.appendChild(renderRankedTwoCols());
      } else if (activeTab === 'podcast') {
        main.appendChild(renderPodcast());
      } else if (activeTab === 'editors' && unlocked) {
        main.appendChild(renderEditors());
      }

      root.appendChild(main);

      // wire header
      qs('#search').addEventListener('input', e => { query = e.target.value; render(); });
      const unlockBtn = qs('#unlock');
      if (unlockBtn) unlockBtn.addEventListener('click', openUnlock);
      const lockBtn = qs('#lock');
      if (lockBtn) lockBtn.addEventListener('click', () => { unlocked = false; activeTab='movies'; render(); });

      qsa('.tab').forEach(btn => btn.addEventListener('click', () => {
        activeTab = btn.getAttribute('data-tab');
        window.scrollTo({ top: 0, behavior: 'instant' }); // fix "opens mid page"
        render();
      }));
    }

    function renderMovies(list, jMap, kMap) {
      const grid = document.createElement('div');
      // 4 columns on lg (bigger posters)
      grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6';
      const cardT = tpl('card-template');

      list.forEach(m => {
        const node = cardT.content.firstElementChild.cloneNode(true);

        // Rank badges (J# top-left, K# top-right)
        const rb = node.querySelector('.ranks');
        const jv = jMap.get(m.id) ?? 'â€”';
        const kv = kMap.get(m.id) ?? 'â€”';
        rb.innerHTML = `<span class="badge">J#${jv}</span><span class="badge badge-light">K#${kv}</span>`;

        // Poster/link
        const posterA = node.querySelector('.posterWrap');
        posterA.href = m.imdbUrl ? m.imdbUrl : 'javascript:void(0)';
        if (m.poster) {
          posterA.innerHTML = `<img src="${esc(m.poster)}" alt="${esc(m.title)} poster" class="w-full h-full object-cover group-hover:scale-[1.02] transition" onload="this.parentElement.classList.remove('poster-skeleton')" onerror="this.style.display='none'">`;
        } else {
          posterA.classList.add('bg-gray-200');
        }

        // Title/year
        node.querySelector('.title').innerHTML = `${esc(m.title||'Untitled')} ${m.year ? `<span class="text-gray-500 font-normal">(${esc(m.year)})</span>` : ''}`;

        // Synopsis
        const syn = node.querySelector('.synopsis');
        if (m.synopsis) syn.textContent = m.synopsis; else syn.remove();

        // Hover meta (Director, top 4 cast, Runtime)
        const hm = node.querySelector('.hovermeta');
        const bits = [];
        if (m.director) bits.push(`Director: ${esc(m.director)}`);
        if (Array.isArray(m.cast) && m.cast.length) bits.push(`Cast: ${esc(m.cast.slice(0,4).join(', '))}`);
        if (m.runtimeMin) bits.push(`Runtime: ${esc(m.runtimeMin)} min`);
        hm.innerHTML = bits.join('<br/>');

        grid.appendChild(node);
      });

      return grid;
    }

    function renderRankedTwoCols() {
      const wrap = document.createElement('div');
      wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';

      const left = document.createElement('div');
      left.className = 'rounded-2xl border p-4';
      left.innerHTML = `<div class="font-semibold mb-3">Jonathanâ€™s Rankings</div><ol id="jlist" class="space-y-1 list-decimal list-inside"></ol>`;

      const right = document.createElement('div');
      right.className = 'rounded-2xl border p-4';
      right.innerHTML = `<div class="font-semibold mb-3">Karlâ€™s Rankings</div><ol id="klist" class="space-y-1 list-decimal list-inside"></ol>`;

      const jlist = qs('#jlist', left);
      const klist = qs('#klist', right);

      // Build arrays sorted by rank ascending
      const jArr = movies.filter(m => m?.ratings?.jonathanRank != null)
        .sort((a,b)=>a.ratings.jonathanRank - b.ratings.jonathanRank);
      const kArr = movies.filter(m => m?.ratings?.karlRank != null)
        .sort((a,b)=>a.ratings.karlRank - b.ratings.karlRank);

      const makeLi = (m, idx, isJ) => {
        const li = document.createElement('li');
        const rank = isJ ? m.ratings.jonathanRank : m.ratings.karlRank;
        const top10 = rank <= 10;
        li.className = top10 ? 'font-semibold' : '';
        li.textContent = m.title || 'Untitled';
        return li;
      };

      jArr.forEach((m,i)=> jlist.appendChild(makeLi(m,i,true)));
      kArr.forEach((m,i)=> klist.appendChild(makeLi(m,i,false)));

      wrap.appendChild(left);
      wrap.appendChild(right);
      return wrap;
    }

    function renderPodcast() {
      const card = document.createElement('div');
      card.className = 'rounded-2xl border p-4';
      const inner = document.createElement('div');
      inner.className = 'rounded-xl border bg-white p-4';

      const header = document.createElement('div');
      header.className = 'text-sm font-medium mb-3';
      header.textContent = 'Listen to our podcast';
      card.appendChild(header);

      if (SITE.podcastEmbed && SITE.podcastEmbed.includes('<iframe')) {
        // Fit the player nicely; Appleâ€™s embed caps width ~660px internally
        inner.innerHTML = SITE.podcastEmbed;
      } else {
        inner.innerHTML = `<div class="text-sm text-gray-600">Paste your Apple Podcasts embed in the Editors tab and Save.</div>`;
      }

      card.appendChild(inner);
      return card;
    }

    function renderEditors() {
      const box = document.createElement('div');
      box.className = 'space-y-6';

      // Password + OMDb + Podcast block
      const siteCard = document.createElement('div');
      siteCard.className = 'rounded-2xl border p-4 space-y-3';
      siteCard.innerHTML = `
        <div class="font-semibold">Site Settings</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <input id="pw-current" class="px-3 py-2 rounded-xl border" type="password" placeholder="Current password"/>
          <input id="pw-new" class="px-3 py-2 rounded-xl border" type="password" placeholder="New password"/>
          <input id="pw-confirm" class="px-3 py-2 rounded-xl border" type="password" placeholder="Confirm new password"/>
          <button id="pw-save" class="px-3 py-2 rounded-xl border bg-black text-white">Change Password</button>
          <div id="pw-msg" class="text-sm text-gray-600 md:col-span-2"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <input id="omdb-key" class="px-3 py-2 rounded-xl border md:col-span-2" type="text" placeholder="OMDb API Key (optional)" value="${esc(SITE.omdbKey||'')}"/>
          <button id="omdb-save" class="px-3 py-2 rounded-xl border">Save OMDb Key</button>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium">Apple Podcasts Embed</label>
          <textarea id="pod-embed" rows="3" class="w-full px-3 py-2 rounded-xl border" placeholder="Paste the <iframe> from Apple Podcasts">${esc(SITE.podcastEmbed||'')}</textarea>
          <button id="pod-save" class="px-3 py-2 rounded-xl border">Save Podcast Embed</button>
        </div>`;
      box.appendChild(siteCard);

      // Movies inline editor
      const listCard = document.createElement('div');
      listCard.className = 'rounded-2xl border p-4';
      listCard.innerHTML = `
        <div class="font-semibold mb-3">Edit Existing Movies</div>
        <input id="filter" placeholder="Filter by title..." class="px-3 py-2 rounded-xl border w-full md:w-80 mb-4"/>
        <div id="e-list" class="space-y-6"></div>`;
      box.appendChild(listCard);

      // Wire site settings
      const pwCur = qs('#pw-current', siteCard);
      const pwNew = qs('#pw-new', siteCard);
      const pwCon = qs('#pw-confirm', siteCard);
      const pwBtn = qs('#pw-save', siteCard);
      const pwMsg = qs('#pw-msg', siteCard);
      pwBtn.onclick = async () => {
        if (pwCur.value !== SITE.editPassword) { pwMsg.textContent = 'Current password is incorrect.'; pwMsg.className='text-sm text-red-600'; return; }
        if (!pwNew.value || pwNew.value !== pwCon.value) { pwMsg.textContent = 'New passwords do not match.'; pwMsg.className='text-sm text-red-600'; return; }
        SITE.editPassword = pwNew.value;
        pwMsg.textContent = 'Password updated.'; pwMsg.className='text-sm text-green-600';
        await saveToCloud(movies, SITE);
      };

      qs('#omdb-save', siteCard).onclick = async () => {
        SITE.omdbKey = qs('#omdb-key', siteCard).value.trim();
        await saveToCloud(movies, SITE);
        alert('OMDb key saved.');
      };

      qs('#pod-save', siteCard).onclick = async () => {
        SITE.podcastEmbed = qs('#pod-embed', siteCard).value.trim();
        await saveToCloud(movies, SITE);
        alert('Podcast embed saved. Check the Podcast tab.');
      };

      // Render movie rows
      const container = qs('#e-list', listCard);
      const filter = qs('#filter', listCard);
      const rows = (movies.slice().sort((a,b)=> (a.title||'').localeCompare(b.title||'')));
      const paint = () => {
        const term = filter.value.trim().toLowerCase();
        container.innerHTML = '';
        rows.forEach((m, idx) => {
          if (term && !(m.title||'').toLowerCase().includes(term)) return;
          const row = document.createElement('div');
          row.className = 'rounded-lg border p-3 grid grid-cols-1 md:grid-cols-6 gap-2 items-start';

          row.innerHTML = `
            <input class="e-title px-2 py-2 rounded border md:col-span-2" placeholder="Title" value="${esc(m.title||'')}"/>
            <input class="e-year px-2 py-2 rounded border" placeholder="Year" value="${esc(m.year||'')}"/>
            <input class="e-jrank px-2 py-2 rounded border" placeholder="Jonathan Rank" value="${esc(m?.ratings?.jonathanRank ?? '')}"/>
            <input class="e-krank px-2 py-2 rounded border" placeholder="Karl Rank" value="${esc(m?.ratings?.karlRank ?? '')}"/>
            <input class="e-imdb px-2 py-2 rounded border md:col-span-3" placeholder="IMDb URL" value="${esc(m.imdbUrl||'')}"/>
            <button class="btn-fetch px-2 py-2 rounded border">Fetch IMDb</button>

            <input class="e-poster px-2 py-2 rounded border md:col-span-3" placeholder="Poster URL" value="${esc(m.poster||'')}"/>
            <input class="e-dir px-2 py-2 rounded border" placeholder="Director" value="${esc(m.director||'')}"/>
            <input class="e-cast px-2 py-2 rounded border md:col-span-2" placeholder="Cast (comma-separated)" value="${esc(Array.isArray(m.cast)?m.cast.join(', '):'')}"/>
            <input class="e-run px-2 py-2 rounded border" placeholder="Runtime (min)" value="${esc(m.runtimeMin||'')}"/>

            <textarea class="e-syn px-2 py-2 rounded border md:col-span-5" rows="2" placeholder="Synopsis">${esc(m.synopsis||'')}</textarea>
            <div class="flex gap-2 justify-end md:col-span-1">
              <button class="btn-save px-3 py-2 rounded border bg-black text-white">Save</button>
              <button class="btn-del px-3 py-2 rounded border">Delete</button>
            </div>
          `;

          // Wire row
          const getVals = () => {
            const get = cls => qs(cls, row).value.trim();
            const title = get('.e-title');
            const year = get('.e-year') ? Number(get('.e-year')) : null;
            const imdb = get('.e-imdb');
            const poster = get('.e-poster');
            const director = get('.e-dir');
            const cast = get('.e-cast').split(',').map(s=>s.trim()).filter(Boolean);
            const runtimeMin = get('.e-run') ? Number(get('.e-run')) : null;
            const synopsis = qs('.e-syn', row).value.trim();
            const jrank = get('.e-jrank') ? Number(get('.e-jrank')) : null;
            const krank = get('.e-krank') ? Number(get('.e-krank')) : null;
            return { title, year, imdb, poster, director, cast, runtimeMin, synopsis, jrank, krank };
          };

          qs('.btn-save', row).onclick = async () => {
            const v = getVals();
            m.title = v.title; m.year = v.year;
            m.imdbUrl = v.imdb;
            m.poster = v.poster; m.director = v.director;
            m.cast = v.cast; m.runtimeMin = v.runtimeMin; m.synopsis = v.synopsis;
            m.ratings = m.ratings || {};
            m.ratings.jonathanRank = v.jrank;
            m.ratings.karlRank = v.krank;
            if (!m.id) m.id = (m.title||'untitled').toLowerCase().replace(/[^a-z0-9]+/g,'-') + '-' + Math.random().toString(36).slice(2,7);
            await saveToCloud(movies, SITE);
            alert('Saved.');
          };

          qs('.btn-del', row).onclick = async () => {
            if (!confirm('Delete this movie?')) return;
            movies = movies.filter(x => x !== m);
            await saveToCloud(movies, SITE);
            paint();
          };

          qs('.btn-fetch', row).onclick = async () => {
            const imdbUrl = qs('.e-imdb', row).value.trim();
            if (!imdbUrl) return alert('Paste an IMDb URL first.');
            if (!SITE.omdbKey) return alert('Add your OMDb API key in Site Settings, then try again.');
            try {
              // Try to parse tt id
              const match = imdbUrl.match(/tt\d+/);
              if (!match) throw new Error('Could not find IMDb tt id in URL.');
              const tt = match[0];
              const r = await fetch(`https://www.omdbapi.com/?i=${tt}&plot=short&r=json&apikey=${encodeURIComponent(SITE.omdbKey)}`);
              const j = await r.json();
              if (j.Response === 'False') throw new Error(j.Error || 'OMDb error');

              // Fill fields
              qs('.e-title', row).value = j.Title || '';
              qs('.e-year', row).value = j.Year || '';
              qs('.e-dir', row).value = j.Director || '';
              qs('.e-cast', row).value = j.Actors || '';
              qs('.e-run', row).value = j.Runtime ? (j.Runtime.replace(' min','')) : '';
              qs('.e-syn', row).value = j.Plot || '';
              // Try poster
              if (j.Poster && j.Poster !== 'N/A') qs('.e-poster', row).value = j.Poster;

              // Save minimal imdbUrl
              qs('.e-imdb', row).value = `https://www.imdb.com/title/${tt}/`;

              alert('Fetched from OMDb. Review and click Save.');
            } catch (e) {
              alert('Fetch failed: ' + e.message);
            }
          };

          container.appendChild(row);
        });
      };
      paint();
      filter.addEventListener('input', paint);

      return box;
    }

    // ---------- Unlock modal ----------
    function openUnlock() {
      const overlay = qs('#unlock-overlay');
      const input = qs('#pw-input');
      const err = qs('#pw-error');
      const btnCancel = qs('#btn-cancel');
      const btnApply = qs('#btn-apply');
      overlay.classList.remove('hidden'); overlay.classList.add('flex');
      input.value=''; input.focus(); err.classList.add('hidden');

      function close() {
        overlay.classList.add('hidden'); overlay.classList.remove('flex');
        btnApply.removeEventListener('click', onApply);
        btnCancel.removeEventListener('click', onCancel);
        input.removeEventListener('keydown', onKey);
      }
      function onCancel(){ close(); }
      function onApply(){
        if (input.value.trim() === SITE.editPassword) {
          unlocked = true; activeTab = 'editors'; close(); render();
        } else { err.classList.remove('hidden'); }
      }
      function onKey(e){ if (e.key==='Enter') onApply(); if (e.key==='Escape') onCancel(); }
      btnCancel.addEventListener('click', onCancel);
      btnApply.addEventListener('click', onApply);
      input.addEventListener('keydown', onKey);
    }

    // ---------- Boot ----------
    (async function init(){
      try {
        const cloud = await loadFromCloud();
        movies = Array.isArray(cloud.movies) ? cloud.movies : [];
        SITE = cloud.site || SITE;
      } catch (e) {
        movies = [];
        SITE = { podcastEmbed:'', editPassword:'sage42', omdbKey:'' };
      }
      render();
    })();
  </script>
</body>
</html>
